% !TEX root = ../paper.tex
\documentclass{standalone}
\input{macros}
\begin{document}


\flushleft

\fbox{$\Rvalid \llbracket \V{ts} \rrbracket_{(\tau l, \V{inst})} : \V{Val} \rightarrow \iProp $}
\[
\begin{array}{rcl}
%
  \Rvalid \llbracket \V{ts} \rrbracket_{(\tau l, \V{inst})}(w) & \triangleq & \exists \V{lh}, v,  w = \V{lh}[\textbf{return}] \ast \V{lh}(0) = v \ast {}
\\
  & & \exists \tau s', \Vvalid\llbracket \tau s' \rrbracket(v) \ast {}
\\
  & & \forall F, F', \rr{allocator}, \frameR{} F' \rr{\ast{} \Avalid(\V{allocator})} \wand
\\
  & & \wprefr{w}{n}{F}{\begin{aligned} \V{w}, &\Vvalid \llbracket \V{ts} \rrbracket(w) \ast{} \frameR{} F' \\ & \rr{\ast{} \exists\V{allocator'}, \Avalid(\V{allocator'})} \end{aligned} }
%
\end{array}
\]

\fbox{$\BRvalid \llbracket [\V{ts}_1; \cdots; \V{ts}_l] \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{\tau_{ret}} : \V{Val} \times \V{Lholed} \rightarrow \iProp$}
% \jean{an asterisk as a superscript is confusing; something fishy is happening with it}
\[
\begin{array}{l}
  \BRvalid \llbracket [\V{ts}_1; \cdots; \V{ts}_l] \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{\tau_{ret}}(w,\V{lh}_n) \triangleq
\\
  \quad
  \begin{array}{l}
    \exists \V{lh}'''_{p},j, w = \V{lh}'''_{p}[\K{\textbf{br }j}]~ \ast
  \\
    \exists \V{vs}',\V{vs}, k, \V{es}, \V{lh}'_m, \V{es}', \V{lh}''_{n - S(j - p)}, \V{ts}',
  \\
    \V{lh}_n(n - S(j - p)) = (\V{vs},k,\V{es},\V{lh}'_m,\V{es}') \ast {}
  \\
    \K{outer}_{n - S(j - p)}(\V{lh}_n) = \V{lh}''_{n - S(j - p)} \ast {}
  \\
    \V{lh}'''_p(0) = (\V{vs}',-) \ast {}
  \\
    \Vvalid\llbracket \V{ts}' \app \V{ts}_{j - p} \rrbracket(\V{vs}') \ast {}
  \\
    \forall F, \rr{\V{allocator}}, \FRvalid\llbracket \tau l \rrbracket_{\V{inst}}(F) \rr{\ast{} \Avalid(\V{allocator})} \wand
  \\
    \wprectxml{\V{vs}}{k}{\V{es}}{\V{lh}_{m}'}{\V{es'}}{\K{drop}~(\K{len}(\V{ts}'))~\V{vs}' \app [\KK{br}~(j - p)]}
    % {\K{len}(\V{ts}_{j - p})}
    % {\V{vs} \mdoubleplus \        [\V{vs},k,\V{es},\V{lh}'_{m}, \V{es}']}
	{\V{w},
        \begin{array}{l}
          \left(
          \begin{array}{l}
          (\exists \tau s, \Vvalid \llbracket \tau s \rrbracket(\V{w})) \vee {} \\
          \left( \exists \tau s, \Hvalid \llbracket \tau s \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{[\V{ts}_{S(S(j - p))}, \cdots, \V{ts}_l], \tau_{ret}}(\V{w}) \right) \vee {} \\
	  \later \BRvalid \llbracket [\V{ts}_{S(S(j - p))}, \cdots, \V{ts}_l] \rrbracket_{(\tau l, \V{inst},\V{hfs})}^{\tau_{ret}}{ \left( \V{w},\V{lh}''_{n - S(j - p)} \right) } \vee {}
	  \\
	  \Rvalid \llbracket \tau_{ret} \rrbracket_{(\tau l, \V{inst})}(w)
	  \end{array}
	  \right) \ast {}
	\\
	  \exists F, \rr{\V{allocator}}, \FRvalid\llbracket \tau l \rrbracket_{\V{inst}}(F)\rr{~\ast{}~ \Avalid(\V{allocator})}\\[1em]
	\end{array}}
  \end{array}
\end{array}
\]

\fbox{$\CONTvalid \llbracket \tau s \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{\tau_{\K{lbs}}, \tau_{\K{ret}}} : \V{Lholed} \times \mathds{N} \rightarrow \iProp $}
\[
\begin{array}{rcl}
 %
  \CONTvalid \llbracket \tau s \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{\tau_{\K{lbs}}, \tau_{\K{ret}}}(\V{lh}_n,j) & \triangleq &
  \begin{array}[t]{l}
    \exists \V{vs}, k, \V{es}, \V{lh}'_m, \V{es'}, \V{lh}''_{n - S(j)},
  \\
    \quad
    \begin{array}{l}
      \V{lh}_n(n - S(j)) = (\V{vs},k,\V{es},\V{lh}',\V{es}') \ast {}
    \\
      \K{outer}_{n - S(j)}(\V{lh}_n) = \V{lh}_{n - S(j)} \ast {}
    \\
    \always \forall v, F, \rr{\V{allocator}}, \Vvalid \llbracket \tau s \rrbracket(v) \wand
                                                                                                          \\
                                                                                                          \qquad{} \FRvalid \llbracket \tau l \rrbracket_{\V{inst}}(F) \wand \rr{\Avalid(\V{allocator}) \wand}
                                                                                                          \\
                                                                                                          \qquad\qquad{} \exists \tau s_2, \Evalid \llbracket \tau s_2 \rrbracket_{\tau l, \V{inst}, \V{hfs})}^{\K{drop}~S(j)~\tau_{\K{lbs}},\tau_{\K{ret}}}{ \left(\V{lh}''_{n - S(j)}, \V{vs}\mdoubleplus v \mdoubleplus \V{es} \mdoubleplus \V{es}' \right) }\\[1em]
      \end{array}
    \end{array}
  \end{array}
\]

\fbox{$\Hvalid \llbracket \V{ts} \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{\tau_{\K{lbs}}, \tau_{\K{ret}}} : \V{Val} \times \V{Lholed} \rightarrow \iProp$}
\[
  \begin{array}{rcl}
    % 
    \Hvalid \llbracket \V{ts} \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{\tau_{\K{lbs}}, \tau_{\K{ret}}}(w,\V{lh}) & \triangleq &
         \begin{array}[t]{l}
           \exists \V{llh}, \V{vs}, \V{ft}, \V{hidx}, \V{ts}_1, \V{ts}_2,\\
           \quad w = \xxWcallhostV~~\V{ft}~\V{hidx}~\V{vs}~\V{llh} ~\ast \\
           \quad ft = \V{ts}_1 \rightarrow \V{ts}_2 ~\ast \\
           \quad (\V{hidx},\V{ft}) \in \V{hfs} ~\ast \\
           \quad \K{allBasicInstr}(\V{llh}) ~\ast \\
           \quad \Vvalid \llbracket \V{ts}_1 \rrbracket(\V{vs}) ~\ast \\
           \quad \always~\forall \V{vs}', F, \rr{\V{allocator}}, \left(\begin{array}{l}
                                                     \Vvalid \llbracket \V{ts}_2 \rrbracket(\V{vs}') ~\wand \\
                                                     \quad \FRvalid \llbracket \tau l \rrbracket_{\V{inst}}(F) ~\wand \rr{\Avalid(\V{allocator})\wand}\\
                                                     \quad \Evalid \llbracket \V{ts} \rrbracket_{(\tau l, \V{inst}, \V{hfs})}^{\tau_{\K{lbs}}, \tau_{\K{ret}}}(\V{lh},\V{llh}[\V{vs}'])
                                                   \end{array}\right)
         \end{array}
     % 
  \end{array}
\]

\end{document}
