% !TEX root = ../paper.tex
\documentclass{standalone}
\input{macros}
\begin{document}
\footnotesize


\[ \inferrule[\texttt{wp\_segload}]{t\neq\xxWhandle \ast{} \wsspt{\V{addr}}~\V{tbs} \ast{} h.\xxWid \allpt\xxSome(x) \ast{} h.\xxWoffset + \mathrm{sizeof}(t)\leq h.\xxWbound \ast{} \\
  \V{addr}=h.\xxWbase+h.\xxWoffset\ast{}h.\xxWvalid=\xxCtrue\ast{}  \textsf{deserialise}(t,\mathrm{untag}(\V{tbs})) = \V{v} \ast{} \later \Phi(\immV{[\V{v}]}) \ast{} \frameR{F}}{\wpre{(\xxWeconstt{\xxWhandle}{h}; \xxWsegload~\V{t})}{w, \Phi(w) \ast{} \wmspt{\V{addr}}~\V{tbs} \ast{} h.\xxWid\allpt\xxSome(x)\ast{} \frameR{F}}} \]

\[ \inferrule[\texttt{wp\_segload\_handle}]{t=\xxWhandle \ast{} \wsspt{\V{addr}}~\V{tbs} \ast{} h.\xxWid \allpt\xxSome(x) \ast{} h.\xxWoffset + \mathrm{sizeof}(t)\leq h.\xxWbound \ast{} \\
  \mathrm{aligned}(\V{addr}, \xxWhandlesize)\ast{}b = \mathrm{allHandle}(\mathrm{tags}(\V{tbs})) \ast{} h_f = \mathrm{updateValid}(h', b \wedge h'.\xxfield{valid})
  \\
  \V{addr}=h.\xxWbase + h.\xxWoffset\ast{} h.\xxWvalid=\xxCtrue\ast{}  \textsf{deserialise}(t,\mathrm{untag}(\V{tbs})) = \V{h'} \ast{} \later \Phi(\immV{[\V{h_f}]}) \ast{} \frameR{F}}{\wpre{(\xxWeconstt{\xxWhandle}{h}; \xxWsegload~\V{t})}{w, \Phi(w) \ast{} \wmspt{\V{addr}}~\V{tbs} \ast{} h.\xxWid\allpt\xxSome(x)\ast{} \frameR{F}}} \]

\[ \inferrule[\texttt{wp\_segload\_failure1}]{\Big(h.\xxWoffset + \mathrm{sizeof}(t)> h.\xxWbound \ast{}\vee h.\xxWvalid=\xxCfalse\vee (t = \xxWhandle \wedge \neg\mathrm{aligned}(h.\xxWbase+h.\xxWoffset,\xxWhandlesize))\Big) \\
  \ast{} \later \Phi(\trapV) \ast{} \frameR{F}}{\wpre{(\xxWeconstt{\xxWhandle}{h}; \xxWsegload~\V{t})}{w, \Phi(w) \ast{}\frameR{F}}} \]

\[ \inferrule[\texttt{wp\_segload\_failure2}]{h.\xxWid \allpt\xxNone \ast{} \later \Phi(\trapV) \ast{} \frameR{F}}{\wpre{(\xxWeconstt{\xxWhandle}{h}; \xxWsegload~\V{t})}{w, \Phi(w)\ast{} h.\xxWid\allpt\xxNone\ast{} \frameR{F}}} \]

(We omit the similar failure rules for \xxWsegstore and \xxWsegfree.)
 
\[ \inferrule[\texttt{wp\_segstore}]{t\neq\xxWhandle \ast{} \wsspt{\V{addr}}~\V{tbs} \ast{} h.\xxWid\allpt\xxSome(x) \ast{} h.\xxWoffset + \mathrm{sizeof}(t)\leq h.\xxWbound\ast{} \\
  \xxTypeof{\V{v}} = \V{t} \ast{} |\V{bs}| = \mathrm{sizeof}(\V{t}) \ast{} \textsf{serialise}(t,\V{v}) =\V{bs} \ast{} \later \Phi(\immV{[]}) \ast{} \frameR{F}}{\wpre{(\xxWconst.\xxWhandle~\V{h}; \V{v}; \xxWsegstore~\V{t})}{w, \Phi(w) \ast{} \wmspt{\V{addr}}~\mathrm{addTag}(\V{bs}, \xxWNumeric) \ast{} h.\xxWid\allpt\xxSome(x)\ast{} \frameR{F}}} \]

\[ \inferrule[\texttt{wp\_segstore\_handle}]{t=\xxWhandle \ast{} \wsspt{\V{addr}}~\V{tbs} \ast{} h.\xxWid\allpt\xxSome(x) \ast{} h.\xxWoffset + \mathrm{sizeof}(t)\leq h.\xxWbound\ast{} \\
\mathrm{aligned}(\V{addr}, \xxWhandlesize) \ast{} |\V{bs}| = \mathrm{sizeof}(\V{t}) \ast{} \textsf{serialise}(t,h') =\V{bs} \ast{} \later \Phi(\immV{[]}) \ast{} \frameR{F}}{\wpre{(\xxWconst.\xxWhandle~\V{h}; \xxWconst.\xxWhandle~\V{h'}; \xxWsegstore~\V{t})}{w, \Phi(w) \ast{} \wmspt{\V{addr}}~\mathrm{addTag}(\V{bs}, \xxWHandle) \ast{} h.\xxWid\allpt\xxSome(x)\ast{} \frameR{F}}} \]

\[ \inferrule[\texttt{wp\_segfree}]{h.\xxWvalid = \xxCtrue \ast{} h.\xxWoffset = 0 \ast{} |\V{tbs}=b| \ast{} \wsspt{h.\xxWbase}\V{tbs}\ast{}h.\xxWid\allpt\xxSome(h.\xxWbase, b)\ast{}\later\Phi(\immV~[])\ast{}\frameR{F}}{\wpre{(\xxWhandle.\xxWconst~h; \xxWsegfree)}{w, \Phi(w)\ast{}\frameR{F}}} \]

\[ \inferrule[\texttt{wp\_segalloc}]{\later(\forall w, (\exists h, w = \immV~[\xxWhandle.\xxWconst~h] \ast{} ( h.\xxWvalid = \xxCfalse~ \vee \\ ( \xxWid \allpt\xxSome(h.\xxWbase, n) \ast{} h.\xxWbound h = n \ast{} h.\xxWoffset = 0 \ast{} h.\xxWvalid = \xxCtrue \ast{} \wsspt{h.\xxWbase}\mathrm{repeat}(0)))) \wand \Phi(w)) \ast{} \frameR{F}}{\wpre{(\xxWithirtytwo.\xxWconst~n; \xxWsegalloc)}{w, \Phi(w)\ast{}\frameR{F}}} \]
    


\end{document}
