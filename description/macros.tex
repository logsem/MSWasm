% !TEX root = paper.tex
\newcommand\aina[1]{\todo[author=Aina, size=\small, color=red!20, inline]{#1}}
\newcommand\rao[1]{\todo[author=Rao, size=\small, color=red!20, inline]{#1}}
\newcommand\lars[1]{\todo[author=Lars, size=\small, color=red!20, inline]{#1}}
\newcommand\jean[1]{\todo[author=Jean, size=\small, color=purple!20, inline]{#1}}
\newcommand\maxime[1]{\todo[author=Maxime, size=\small, color=red!20, inline]{#1}}
\newcommand\conrad[1]{\todo[author=Conrad, size=\small, color=red!20, inline]{#1}}
\newcommand\philippa[1]{\todo[author=Philippa, size=\small, color=red!20, inline]{#1}}

\newcommand\polish[1]{{\color{red} #1 }}

\newcommand{\iriswasm}{Iris-Wasm\xspace}
\newcommand{\irismswasm}{Iris-MSWasm\xspace}

% colors
\newcommand{\textblue}[1]{\textcolor{RoyalBlue}{#1}}

% practical shorthand for various typesetting constructors
\newcommand{\V}[1]{\ensuremath{\mathit{#1}}}
\newcommand{\X}[1]{\ensuremath{\mathrm{#1}}}
\newcommand{\K}[1]{\ensuremath{\mathsf{#1}}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\KK}[1]{\ensuremath{\mathsf{\mathbf{#1}}}}

% list append
\newcommand\doubleplus{+\kern-1.3ex+\kern0.8ex}
\newcommand\cat{+\kern-0.8ex+\kern0.8ex}
\newcommand\mdoubleplus{\ensuremath{\mathbin{+\mkern-5mu+}}}

% relations
\newcommand{\Wvalid}{\ensuremath{\mathcal{V}_0}}
\newcommand{\Vvalid}{\ensuremath{\mathcal{V}}}
\newcommand{\Fvalid}{\ensuremath{\mathcal{F}\!\!\mathit{unc}}}
\newcommand{\Evalid}{\ensuremath{\mathcal{E}}}
\newcommand{\Evalidaux}{\ensuremath{\mathcal{E}_0}}
\newcommand{\CLvalid}{\ensuremath{\mathcal{C}\!\mathit{los}}}
\newcommand{\Tvalid}{\ensuremath{\mathcal{T}\!\!\mathit{ab\ell\!e}}}
\newcommand{\Mvalid}{\ensuremath{\mathcal{M}\mathit{em}}}
\newcommand{\Gvalid}{\ensuremath{\mathcal{G}\mathit{\ell{}\!ob}}}
\newcommand{\Ivalid}{\ensuremath{\mathcal{I}}}
\newcommand{\BRvalid}{\ensuremath{\mathcal{B}r}}
\newcommand{\FRvalid}{\ensuremath{\mathcal{F}\!\!\mathit{rame}}}
\newcommand{\Rvalid}{\ensuremath{\mathcal{R}\!\mathit{et}}}
\newcommand{\CTXvalid}{\ensuremath{\mathcal{C}\!\mathit{tx}}}
\newcommand{\CONTvalid}{\ensuremath{\mathcal{K}}}
\newcommand{\Hvalid}{\ensuremath{\mathcal{H}}}

% special wasm constructs
\newcommand{\NCl}[3]{\ensuremath{\{ #2; #3\}^{\K{NativeCl}}_{#1}}}
\newcommand{\HCl}[2]{\ensuremath{\{ #2\}^{\K{HostCl}}_{#1}}}


% ::=
\newcommand{\dotdoteq}{\ensuremath{\mathrel{\mbox{:\hspace{-0.05em}:\hspace{-0.05em}\raisebox{-0.07ex}{=}}}}\xspace}

% hack to put text closer to arrow (source: https://tex.stackexchange.com/questions/94572/xrightarrow-position-of-text-over-an-arrow-should-be-lower)
\usepackage{ifthen}
\usepackage{xargs}

\newcommandx{\yaHelper}[2][1=\empty]{%
\ifthenelse{\equal{#1}{\empty}}%
  { \ensuremath{ \scriptstyle{ #2 } } } % no offset
  { \raisebox{ #1 }[-#1][0pt]{ \ensuremath{ \scriptstyle{ #2 } } } }  % with offset
}

\newcommandx{\ymapsto}[4][1=\empty, 2=\empty, 4=\empty, usedefault=@]{%
  \ifthenelse{\equal{#2}{\empty}}
  { \xmapsto{ \protect{ \yaHelper[ #4 ]{ #3 } } } } % there's no text below
  { \xmapsto[ \protect{ \yaHelper[ #2 ]{ #1 } } ]{ \protect{ \yaHelper[ #4 ]{ #3 } } } } % there's text below
}

\newcommandx{\yhookrightarrow}[4][1=\empty, 2=\empty, 4=\empty, usedefault=@]{%
  \ifthenelse{\equal{#2}{\empty}}
  { \xhookrightarrow{ \protect{ \yaHelper[ #4 ]{ #3 } } } } % there's no text below
  { \xhookrightarrow[ \protect{ \yaHelper[ #2 ]{ #1 } } ]{ \protect{ \yaHelper[ #4 ]{ #3 } } } } % there's text below
}

% color to highlight wasm from hosts perspective
\newcommand{\hlwasm}[1]{#1}

% macros for robust safety text
\newcommand{\mainspec}{\ensuremath{\K{mainSpec}(\V{es},\V{tlocs},\V{inst})}}

% resources
\newcommand{\frameR}[1]{\ensuremath{\yhookrightarrow{\textsc{Fr}}[-2pt] #1}}
\newcommand{\wfpt}{\ensuremath{\ymapsto{\K{wf}}[-2pt]}}
\newcommand{\wtpt}[1]{\ensuremath{\ymapsto{\K{wt}}[-2pt]_{#1}}}
\newcommand{\wtspt}[1]{\ensuremath{\ymapsto{\K{wts}}[-2pt]_{#1}}}
\newcommand{\wmlenpt}{\ensuremath{\ymapsto{\K{mlen}}[-2pt]}}
\newcommand{\wmlimpt}{\ensuremath{\yhookrightarrow{\K{mlim}}[-2pt]}}
\newcommand{\wmspt}[1]{\ensuremath{\ymapsto{\K{wms}}[-2pt]_{#1}}}
\newcommand{\wmpt}[1]{\ensuremath{\ymapsto{\K{wm}}[-2pt]_{#1}}}
\newcommand{\wgpt}{\ensuremath{\ymapsto{\K{wg}}[-2pt]}}
\newcommand{\wtlenpt}{\ensuremath{\yhookrightarrow{\K{tlen}}[-2.5pt]}}
\newcommand{\wtlimpt}{\ensuremath{\yhookrightarrow{\K{tlim}}[-2.5pt]}}
\newcommand{\hmpt}{\ensuremath{\yhookrightarrow{\K{mod}}[-2.5pt]}}
\newcommand{\hvpt}{\ensuremath{\ymapsto{\K{vis}}[-2.5pt]}}
\newcommand{\hapt}{\ensuremath{\yhookrightarrow{\K{ha}}[-2.5pt]}}

% WPs
\newcommand{\wprefr}[4]{\ensuremath{\wpre{\K{\textbf{local}}_{#2}\{#3\}~#1~\K{\textbf{end}}}{#4}}}
\newcommand{\wprectx}[4]{\ensuremath{\wpre{\K{\textbf{label}}_{#2}\{#3\}~#1~\K{\textbf{end}}}{#4}}}
\newcommand{\wprectxml}[7]{\ensuremath{
\wpre{(#1~\mdoubleplus~\KK{label}_{#2}\{#3\}~#4~\KK{end}~\mdoubleplus~#5)[#6]\\}{#7}}}
\newcommand{\wprehost}[2]{\ensuremath{\wpre{#1}[\textbf{\textsc{host}}]{#2}}}

% WASM code
% The listing and macros should always display the same result
\definecolor{wasmnamecolour}{rgb}{0,0,0.8}
\definecolor{wasmstringcolour}{rgb}{0.8,0,0}
\definecolor{wasmcommentcolour}{rgb}{0,0.5,0}
\definecolor{wasmtriplecolour}{rgb}{0.5,0.5,0.5}

\def\beginlstdelimfront#1#2#3%
{%
    \def\endlstdelim{#2\egroup}%
    \textsf\bgroup\color{#3}#1\aftergroup\endlstdelim%
}
\def\beginlstdelim#1#2#3%
{%
    \def\endlstdelim{\color{#3}\texttt{#2}\egroup}%
    \textsf\bgroup\color{#3}\texttt{#1}\aftergroup\endlstdelim%
}

\lstdefinelanguage{wasm} {
  morekeywords={module, memory, func, export, br, return
    param, loop, end, i32, store, load, segload, segstore, import, table, elem, const,
    handleadd, slice, segalloc, segfree, handle,
  funcref, local, result, call, global, get, set, call_indirect, instantiate, param, unreachable, drop, grow, type, if, then, else, return, select, eq, add, sub, rem_u,div_u, mul, mut, tee, align, start},
  % morestring=[b]",
  morecomment=[l];;,
  commentstyle=\color{wasmcommentcolour}\textsf,
  moredelim=**[is][\beginlstdelimfront{\$}{}{wasmnamecolour}]{[}{]},
  % stringstyle=\color{wasmstringcolour}\textsf,
  moredelim=**[is][\beginlstdelim{"}{"}{wasmstringcolour}]{"}{"},
  sensitive=true,
  keywordstyle= \bfseries\textsf,
  mathescape=true,
  texcl=false,
  escapechar={},
  basicstyle=\small
}

\lstnewenvironment{wasmlisting}
{
  \lstset{language=wasm,
          breaklines=true,
          columns=fullflexible,
          escapeinside={[*@}{@*]}}
}{}

% Coq types
\newcommand\xxCN{\ensuremath{\mathbf{N}}\xspace}
\newcommand\xxCbool{\ensuremath{\mathbf{bool}}\xspace}
\newcommand\xxCtrue{\ensuremath{\mathbf{true}}\xspace}
\newcommand\xxCfalse{\ensuremath{\mathbf{false}}\xspace}
\newcommand\xxCMEempty{\ensuremath{\mathbf{ME\_empty}}\xspace}


% Wasm commands and constructors
\newcommand\xxWmodule{\ensuremath{\mathbf{module}}\xspace}\newcommand\xxWtype{\ensuremath{\mathbf{type}}\xspace}
\newcommand\xxWmemory{\ensuremath{\mathbf{memory}}\xspace}
\newcommand\xxWglobal{\ensuremath{\mathbf{global}}\xspace}
\newcommand\xxWfunc{\ensuremath{\mathbf{func}}\xspace}
\newcommand\xxWexport{\ensuremath{\mathbf{export}}\xspace}
\newcommand\xxWparam{\ensuremath{\mathbf{param}}\xspace}
\newcommand\xxWithirtytwo{\ensuremath{\mathbf{i32}}\xspace}
\newcommand\xxWfthirtytwo{\ensuremath{\mathbf{f32}}\xspace}
\newcommand\xxWisixtyfour{\ensuremath{\mathbf{i64}}\xspace}
\newcommand\xxWfsixtyfour{\ensuremath{\mathbf{f64}}\xspace}
\newcommand\xxWhandle{\ensuremath{\mathbf{handle}}\xspace}
\newcommand\xxWbase{\ensuremath{\mathbf{base}}\xspace}
\newcommand\xxWoffset{\ensuremath{\mathbf{offset}}\xspace}
\newcommand\xxWbound{\ensuremath{\mathbf{bound}}\xspace}
\newcommand\xxWvalid{\ensuremath{\mathbf{valid}}\xspace}
\newcommand\xxWid{\ensuremath{\mathbf{id}}\xspace}
\newcommand\xxWloop{\ensuremath{\mathbf{loop}}\xspace}
\newcommand\xxWend{\ensuremath{\mathbf{end}}\xspace}
\newcommand\xxWstore{\ensuremath{\mathbf{store}}\xspace}
\newcommand\xxWsegstore{\ensuremath{\mathbf{segstore}}\xspace}
\newcommand\xxWslice{\ensuremath{\mathbf{slice}}\xspace}
\newcommand\xxWhandleadd{\ensuremath{\mathbf{handle.add}}\xspace}
\newcommand\xxWsegalloc{\ensuremath{\mathbf{segalloc}}\xspace}
\newcommand\xxWsegfree{\ensuremath{\mathbf{segfree}}\xspace}
\newcommand\xxWload{\ensuremath{\mathbf{load}}\xspace}
\newcommand\xxWsegload{\ensuremath{\mathbf{load}}\xspace}
\newcommand\xxWNumeric{\ensuremath{\mathbf{Numeric}}\xspace}
\newcommand\xxWHandle{\ensuremath{\mathbf{Handle}}\xspace}
\newcommand\xxWimport{\ensuremath{\mathbf{import}}\xspace}
\newcommand\xxWtable{\ensuremath{\mathbf{table}}\xspace}
\newcommand\xxWelem{\ensuremath{\mathbf{elem}}\xspace}
\newcommand\xxWconst{\ensuremath{\mathbf{const}}\xspace}
\newcommand\xxWfuncref{\ensuremath{\mathbf{funcref}}\xspace}
\newcommand\xxWblock{\ensuremath{\mathbf{block}}\xspace}
\newcommand\xxWif{\ensuremath{\mathbf{if}}\xspace}
\newcommand\xxWresult{\ensuremath{\mathbf{result}}\xspace}
\newcommand\xxWcall{\ensuremath{\mathbf{call}}\xspace}
\newcommand\xxWcallhost{\ensuremath{\mathbf{call\_host}}\xspace}
\newcommand\xxWcallhostV{\ensuremath{\mathbf{call\_hostV}}\xspace}
\newcommand\xxWcallwasm{\ensuremath{\mathbf{call\_wasm}}\xspace}
\newcommand\xxWlocalget{\ensuremath{\mathbf{local.get}}\xspace}
\newcommand\xxWlocalset{\ensuremath{\mathbf{local.set}}\xspace}\newcommand\xxWlocaltee{\ensuremath{\mathbf{local.tee}}\xspace}
\newcommand\xxWglobalset{\ensuremath{\mathbf{global.set}}\xspace}
\newcommand\xxWglobalget{\ensuremath{\mathbf{global.get}}\xspace}
\newcommand\xxWname[1]{\ensuremath{\textcolor{wasmnamecolour}{\mathsf{\$#1}}}}
\newcommand\xxWtriple[1]{\ensuremath{\textcolor{wasmtriplecolour}{\{#1\}}}}
\newcommand\xxWstring[1]{\ensuremath{\textcolor{wasmstringcolour}{\mathsf{\texttt{"}#1\texttt{"}}}}}
\newcommand\xxWcallindirect[1]{\ensuremath{%
\mathbf{call\text{\_}indirect}~#1%
}}
\newcommand\xxWcallindirectZ{\ensuremath{%
\mathbf{call\text{\_}indirect}%
}}
\newcommand\xxWcomment[1]{\ensuremath{\textcolor{wasmcommentcolour}{\mathsf{;; #1}}}}

\newcommand\xxTypeof[1]{\ensuremath{\mathbf{typeof}(\mathsf{#1})}}

\newcommand\xxWisconst[1]{\ensuremath{\mathbf{is\_const}(\mathsf{#1})}}
\newcommand\xxWadd{\ensuremath{\mathbf{add}}}
\newcommand\xxWbr[1]{\ensuremath{\mathbf{br}~#1}\xspace}
\newcommand\xxWbrif[1]{\ensuremath{\mathbf{br\_if}~#1}\xspace}
\newcommand\xxWbrtable{\ensuremath{\mathbf{br\_table}}\xspace}
\newcommand\xxWreturn{\ensuremath{\mathbf{return}}\xspace}
\newcommand\xxWeconst[1]{\ensuremath{\mathbf{const~#1}}}
%
\newcommand\xxWeconstt[2]{\ensuremath{#1.\mathbf{const}~#2}}

\newcommand\xxWtrap{\ensuremath{\mathbf{trap}}\xspace}
\newcommand\xxWunop[2]{\ensuremath{#1.\mathbf{unop}~#2}}
\newcommand\xxWbinop[2]{\ensuremath{#1.\mathbf{binop}~#2}}
\newcommand\xxWcvtopcvt[3]{\ensuremath{#1.\mathbf{cvtop_{convert}}~#2~#3}}
\newcommand\xxWunreachable{\ensuremath{\mathbf{unreachable}}\xspace}
\newcommand\xxWnop{\ensuremath{\mathbf{nop}}\xspace}
\newcommand\xxWdrop{\ensuremath{\mathbf{drop}}\xspace}
\newcommand\xxWselect{\ensuremath{\mathbf{select}}\xspace}
\newcommand\xxWcurrentmemory{\ensuremath{\mathbf{current\_memory}}\xspace}
\newcommand\xxWgrowmemory{\ensuremath{\mathbf{grow\_memory}}\xspace}
\newcommand\xxWlabel[3]{\ensuremath{\K{\textbf{label}}_{#1}\{#2\}~\V{#3}~\K{\textbf{end}}}}
\newcommand\xxWlocal[3]{\ensuremath{\K{\mathbf{local}}_{#1}\{#2\}~\V{#3}~\K{\textbf{end}}}}
\newcommand\xxWret{\ensuremath{\mathbf{return}}\xspace}
\newcommand\xxWinst{\ensuremath{\mathsf{instantiate}}\xspace}
\newcommand\xxWlfilled[4]{\ensuremath{%
#2_{#1}[#3] = #4%
}}
\newcommand\xxWinvoke{\ensuremath{\mathbf{invoke}}\xspace}
\newcommand\xxSome{\ensuremath{\mathsf{Some}}}

% Logical values
\newcommand\immV[1]{\ensuremath{\KK{immV}~\mathit{#1}}}
\newcommand\trapV{\ensuremath{\KK{trapV}}}
\newcommand\brV[2]{\ensuremath{\KK{brV}~\mathit{#1}~\mathit{#2}}}
\newcommand\retV[1]{\ensuremath{\KK{retV}~\mathit{#1}}}
\newcommand\callhostV[4]{\ensuremath{\xxWcallhostV~\mathit{#1}~\mathit{#2}~\mathit{#3}~\mathit{#4}}}

% Conversions
\newcommand\xxWtoval[1]{\ensuremath{\KK{to\_val}~(#1)}}

%misc notation macros for proof rules
\newcommand\pagesize{64\mathsf{Ki}}
\newcommand\nzeros[1]{\KK{zeros}(#1)}

% Workaround for array \cr within inferrule contexts to display multiline arrays as premises, since they clash
\makeatletter
\def\arrcr{\@arraycr}
\makeatother

% host instructions
\newcommand\xxHinstantiate[3]{\ensuremath{\mathbf{inst\_decl}~\mathsf{#1}~\mathsf{#2}~\mathsf{#3}}}
\newcommand\xxHgetglobal[1]{\ensuremath{\mathbf{get\_global}~\mathsf{#1}}}

\newcommand\xxfield[1]{\ensuremath{\mathsf{#1}}}


\newcommand\xxsalloc[7]{\ensuremath{\langle #1, #2 \rangle\overset{\mathrm{salloc}(#3, #4, #5)}{\hookrightarrow}\langle #6, #7 \rangle}\xspace}
\newcommand\xxsfree[6]{\ensuremath{\langle #1, #2 \rangle\overset{\mathrm{sfree}(#3, #4)}{\hookrightarrow}\langle #5, #6 \rangle}\xspace}
